shinyServer(function(input, output, session) {
  
  # GLOBAL & REACTIVE VARS -----------------------------------
  inserted_vars = NULL
  
  r <- reactiveValues(
    picked_vars = NULL,
    picked_df = NULL
  )
  
  # VARS TABLE ------------------------------------------------
  output$table_vars <- renderDT({
    input$bt_clear
    
    datatable(NISPUF14_VARS,
              style = "auto",
              rownames = F,
              selection = list(mode = "multiple"),
              options = list(searching = T, paging = F, scrollY = "500"))
  })
  
  observeEvent(input$table_vars_row_last_clicked, {
    r$picked_vars <- NISPUF14_VARS$key[input$table_vars_rows_selected]
    r$picked_df <- select(NISPUF14, r$picked_vars)
  })
  
  observeEvent(input$bt_clear, {
    for(var in inserted_vars) {
      removeUI(selector = paste0("#s_",var))
    }
    updateSelectInput(session, "s_xaxis", choices = character(0))
    updateSelectInput(session, "s_measures", choices = character(0))
    r$picked_vars <- NULL
    r$picked_df <- NULL
    inserted_vars <<- NULL
  })
  
  # QUICK SUMMARY ------------------------------------------------
  output$text_summary <- renderPrint({
    if (length(r$picked_vars) > 0) {
      
      get_summary <- function(vec) {
        if (!is.factor(vec)) {  
          quants <- unique(quantile(vec, na.rm = T))
          vec <- if (length(quants) > 1) cut(vec, quants) else factor(vec)
        }
        dat <- fct_count(vec)
        dat$`%` <- round(100*dat$n/sum(dat$n), 3)
        return(as.data.frame(dat))
      }
      
      lapply(r$picked_df, get_summary)
    }
  })
  
  # GROUPED TABLE ------------------------------------------------
  output$table_grouped <- renderDT({
    if (length(r$picked_vars) > 0) {
      
      dat <- r$picked_df %>% 
        group_by_if(is.factor) %>% 
        summarise(
          freq = n(), 
          across(where(is.numeric), ~ mean(.x, na.rm = TRUE)),
          .groups = "drop")
      
      datatable(dat,
                style = "auto",
                rownames = F,
                selection = "none",
                options = list(searching = F, paging = F, scrollY = "500", scrollX = T))
    }
  })
  
  # GROUPED PLOT ------------------------------------------------
  output$plot_grouped <- renderPlot({
    if(length(r$picked_vars) > 0) {
      
      dat <- select(r$picked_df, where(is.factor))
      nm <- colnames(dat)
      n <- ncol(dat)
      
      if(n > 0) {
        colnames(dat) <- paste0("c",1:n)
        if (n >= 1) {p <- ggplot(dat, aes(c1)) + geom_bar() + labs(x = nm[1])} 
        if (n >= 2) {p <- p + geom_bar(aes(fill = c2)) + labs(fill = nm[2])}
        if (n >= 3) {p <- p + facet_grid(c3 ~ .)}
        if (n >= 4) {p <- p + facet_grid(c3 ~ c4)}
        p + guides(x = guide_axis(angle = 25))
      }
    }
  
  })
  
  # EXAMINE ---------------------------------------------------
  observeEvent(input$table_vars_row_last_clicked, {
    updateSelectInput(session, "s_xaxis", choices = r$picked_vars)
    updateSelectInput(session, "s_measures", choices = r$picked_vars)
    n_picked <- length(r$picked_vars)
    n_inserted <- length(inserted_vars)

    if (n_inserted == 0) {
      var <- r$picked_vars
    } else { 
      var <- union(setdiff(r$picked_vars, inserted_vars), 
                   setdiff(inserted_vars, r$picked_vars))
    }
    
    if (n_picked > n_inserted) {
      lbl <- paste0(var,": ",tolower(NISPUF14_VARS$lbl[NISPUF14_VARS$key == var]))
      vec <- r$picked_df[[var]]
      if (is.factor(vec)) {
        elem <- selectInput(var, lbl, choices = levels(vec), multiple = T, selectize = F)
      } else if (is.numeric(vec)) {
        elem <- sliderInput(var, lbl, round = 1, 
                            min =  min(vec, na.rm = T), 
                            max = max(vec, na.rm = T), 
                            value = range(vec, na.rm = T))
      }
      insertUI(
        selector = "#div_filters",
        ui = span(id = paste0("s_",var), elem)
      )
      inserted_vars <<- c(inserted_vars, var)
    } else {
      removeUI(selector = paste0("#s_",var))
      inserted_vars <<- inserted_vars[inserted_vars != var]
    }
  })
  
  observeEvent(input$bt_examine, {
    if (is.null(r$picked_vars) || length(r$picked_vars) == 0) {
      showModal(modalDialog(title = NULL, footer = NULL, easyClose = T, TXT_PICKONE))
    } else {
      updateNavbarPage(session, "navbar", selected = "tab_examine") 
    }
  })
  
  output$plot_examine <- renderPlot({
    if (length(r$picked_df) > 0) {
      r$picked_df %>% 
      ggplot(aes(x = .data[[input$s_xaxis]])) +
        geom_bar(aes(fill = .data[[input$s_measures]]),
                 position = "fill")
    }
  })
  
  observeEvent(input$bt_apply, {
    filter_vars <- r$picked_vars[sapply(r$picked_vars, \(x) !is.null(input[[x]]))]
    
    if (length(filter_vars) > 0) {
      r$picked_df <- NISPUF14 %>%
        select(r$picked_vars) %>% 
        filter((if_all(
            .cols = all_of(filter_vars),
            .fns  = ~ .x %in% input[[cur_column()]])))
    }
  })
})